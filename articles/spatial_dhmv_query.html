<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Dissecting a WCS Query: DHMV Case Study. • inbospatial</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Dissecting a WCS Query: DHMV Case Study.">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="default" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">inbospatial</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/spatial_dhmv_query.html">Dissecting a WCS Query: DHMV Case Study.</a></li>
    <li><a class="dropdown-item" href="../articles/wfs_wcs.html">Example use cases to get data from web feature or web coverage services.</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/inbo/inbospatial/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Dissecting a WCS Query: DHMV Case Study.</h1>
                        <h4 data-toc-skip class="author">Falk Mielke (<a href="mailto:falk.mielke@inbo.be" class="email">falk.mielke@inbo.be</a>)</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/inbo/inbospatial/blob/main/vignettes/spatial_dhmv_query.Rmd" class="external-link"><code>vignettes/spatial_dhmv_query.Rmd</code></a></small>
      <div class="d-none name"><code>spatial_dhmv_query.Rmd</code></div>
    </div>

    
    
<p><a id="org86b1211"></a></p>
<div class="section level2">
<h2 id="dhmv-data">DHMV Data<a class="anchor" aria-label="anchor" href="#dhmv-data"></a>
</h2>
<p>Flemish government agencies host a lot of useful web services and
data. Some of those are available via web services and can be found
here:</p>
<ul>
<li><a href="https://www.vlaanderen.be/datavindplaats/catalogus" class="external-link uri">https://www.vlaanderen.be/datavindplaats/catalogus</a></li>
</ul>
<p>This vignette demonstrates the <strong>query of elevation data from
the Digital Elevation Model</strong>,
<code>Digitaal HoogteModel Vlaanderen</code> (DHMV). We will do it “the
complicated way”, assembling a Web Coverage Service (WCS) query. <a href="#orgd59526e">In the end</a>, you will see how to use
<code>inbospatial</code> to get the same result in a single function
call.</p>
<p>This vignette is somewhat related to, but goes beyond the use of Web
Feature Services (WFS) for spatial data, <a href="https://tutorials.inbo.be/tutorials/spatial_wfs_services/" class="external-link">see
this tutorial by Thierry Onkelinx</a>. In particular, I will document
some paths and workarounds to explore if errors occur in the default
<code>ows4R</code> procedure.</p>
<p><strong>TL;DR:</strong> see the
<code>?inbospatial:get_coverage_wcs</code> function to query DHMV (or
other WCS) data of a given point in Flanders. An example can be found
below.</p>
<p><a id="org75073fb"></a></p>
</div>
<div class="section level2">
<h2 id="situationmotivation">Situation/Motivation<a class="anchor" aria-label="anchor" href="#situationmotivation"></a>
</h2>
<p>The purpose of the code below is to query elevation data for an
arbitrary location in Flanders. It can be found here:</p>
<ul>
<li><a href="https://www.vlaanderen.be/datavindplaats/catalogus/wcs-digitaal-hoogtemodel-vlaanderen" class="external-link uri">https://www.vlaanderen.be/datavindplaats/catalogus/wcs-digitaal-hoogtemodel-vlaanderen</a></li>
</ul>
<p>Unfortunately, documentation about the WCS is sparse, so let’s hope
it complies with given standards.</p>
<p>We will use Web Coverage Services (WCS), as standardized by the Open
Geospatial Consortium (OGC). More info on these services can be found <a href="https://r.geocompx.org/read-write#geographic-web-services" class="external-link">in the
“Geocomputation with R” book, for example</a>. The go-to R package for
WCS is <code>ows4R</code> by Emmanuel Blondel and contributors, <a href="https://eblondel.github.io/ows4R/" class="external-link">available on github</a>.</p>
<p>Unfortunately, neither the geocomputation book’s example, nor the
vignette in <a href="https://eblondel.github.io/ows4R/articles/wcs.html" class="external-link">the
<code>ows4R</code> package</a>, nor <a href="https://tutorials.inbo.be/tutorials/spatial_wfs_services/" class="external-link">the
INBO tutorial</a> could be transferred to the DHMV use case. The code
simply did not work.</p>
<p>Therefore, I ended up going back to the nitty-gritty aspects of WCS
by <strong>manually building a query</strong>.</p>
<p><a id="orge6d66b9"></a></p>
</div>
<div class="section level2">
<h2 id="limits-of-ows4r-package">Limits of <code>ows4R</code> Package<a class="anchor" aria-label="anchor" href="#limits-of-ows4r-package"></a>
</h2>
<p>Before revealing <a href="#org803f24d">the solution</a>, I will
document the error and my path to working around it: the core problem
was not trivial to see, and you might run into similar issues.</p>
<p>Because, in fact, the <code>ows4R</code> package seems functional. In
the tutorial mentioned above, <a href="https://CRAN.R-project.org/package=ows4R" class="external-link">the <code>ows4R</code>
package</a> is used to query data from web services. However,
<code>ows4R</code> cannot handle all niche server interfaces.</p>
<p>First, we need to load some packages.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://httr.r-lib.org/" class="external-link">"httr"</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://r-spatial.github.io/sf/" class="external-link">"sf"</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Linking to GEOS 3.12.1, GDAL 3.8.4, PROJ 9.4.0; sf_use_s2() is TRUE</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://rspatial.org/" class="external-link">"terra"</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; terra 1.7.83</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"ows4R"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"ows4R"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Loading ISO 19139 XML schemas...</span></span>
<span><span class="co">#&gt; Loading ISO 19115 codelists...</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/eblondel/ows4R" class="external-link">"ows4R"</a></span><span class="op">)</span></span></code></pre></div>
<p>We can connect a WCS client.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wcs</span> <span class="op">&lt;-</span> <span class="va"><a href="https://eblondel.github.io/ows4R/reference/WCSClient.html" class="external-link">WCSClient</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  <span class="st">"https://geo.api.vlaanderen.be/DHMV/wcs"</span>, <span class="st">"2.0.1"</span>,</span>
<span>  logger <span class="op">=</span> <span class="st">"INFO"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; [ows4R][INFO] OWSGetCapabilities - Fetching https://geo.api.vlaanderen.be/DHMV/wcs?service=WCS&amp;version=2.0.1&amp;request=GetCapabilities </span></span>
<span><span class="co">#&gt;   |                                                                              |                                                                      |   0%  |                                                                              |======================================================================| 100%</span></span></code></pre></div>
<p>We can easily query the capabilities:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">caps</span> <span class="op">&lt;-</span> <span class="va">wcs</span><span class="op">$</span><span class="fu">getCapabilities</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>This would grab the same info as you can find in this xml file: <a href="https://geo.api.vlaanderen.be/DHMV/wcs?service=WCS&amp;request=getcapabilities" class="external-link uri">https://geo.api.vlaanderen.be/DHMV/wcs?service=WCS&amp;request=getcapabilities</a></p>
<p>Note that the <em>capabilities</em> xml holds a lot of valuable
information:</p>
<ul>
<li>First and foremost, search it for <code>CoverageID</code>; in this
case, I was interested in <code>DHMVII_DTM_1m</code>: grid coverage of
the LIDAR elevation data for Flanders.</li>
<li>We can also find that the Coordinate Reference System (CRS)
<code>crsSupported</code> is <a href="https://epsg.org/crs_31370/BD72-Belgian-Lambert-72.html" class="external-link">BD72 /
Belgian Lambert 72</a>. Always good to know.</li>
<li>Finally, the capabilities xml provides a <code>version</code>: 2.0.1
at the time of writing. Yet keep that in mind for a bit.</li>
</ul>
<p>The “capabilities” are, per OGC standards, your go-to place for
finding WCS documentation.</p>
<p>In R, we can receive further information conveniently via
<code>ows4R</code>. This works via the “coverage summary” …</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">feature</span> <span class="op">&lt;-</span> <span class="st">"DHMVII_DTM_1m"</span></span>
<span><span class="va">dtm_smry</span> <span class="op">&lt;-</span> <span class="va">caps</span><span class="op">$</span><span class="fu">findCoverageSummaryById</span><span class="op">(</span><span class="va">feature</span>, exact <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">dtm_smry</span></span>
<span><span class="co">#&gt; <span style="color: #BBBBBB;">&lt;</span><span style="color: #BBBBBB; text-decoration: underline;">WCSCoverageSummary</span><span style="color: #BBBBBB;">&gt;</span></span></span>
<span><span class="co">#&gt; ....|-- <span style="font-style: italic;">CoverageId</span>: <span style="background-color: #BBBBBB;">DHMVII_DTM_1m</span></span></span>
<span><span class="co">#&gt; ....|-- <span style="font-style: italic;">CoverageSubtype</span>: <span style="background-color: #BBBBBB;">GridCoverage</span></span></span>
<span><span class="co">#&gt; ....|-- <span style="font-style: italic;">WGS84BoundingBox</span> <span style="color: #BBBBBB;">&lt;</span><span style="color: #BBBBBB; text-decoration: underline;">OWSWGS84BoundingBox</span><span style="color: #BBBBBB;">&gt;</span></span></span>
<span><span class="co">#&gt; ........|-- <span style="font-style: italic;">LowerCorner</span>: <span style="background-color: #BBBBBB;">2.52 50.64</span></span></span>
<span><span class="co">#&gt; ........|-- <span style="font-style: italic;">UpperCorner</span>: <span style="background-color: #BBBBBB;">5.94 51.51</span></span></span></code></pre></div>
<p>… and the coverage description.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get description from the WCS client</span></span>
<span><span class="va">dtm_des</span> <span class="op">&lt;-</span> <span class="va">wcs</span><span class="op">$</span><span class="fu">describeCoverage</span><span class="op">(</span><span class="va">feature</span><span class="op">)</span></span>
<span><span class="co">#&gt; [ows4R][INFO] WCSClient - Fetching coverageSummary description for 'DHMVII_DTM_1m' ... </span></span>
<span><span class="co">#&gt; [ows4R][INFO] WCSDescribeCoverage - Fetching https://geo.api.vlaanderen.be/DHMV/wcs?service=WCS&amp;version=2.0.1&amp;coverageId=DHMVII_DTM_1m&amp;request=DescribeCoverage </span></span>
<span><span class="co">#&gt;   |                                                                              |                                                                      |   0%  |                                                                              |======================================================================| 100%</span></span>
<span><span class="va">dtm_des</span></span>
<span><span class="co">#&gt; <span style="color: #BBBBBB;">&lt;</span><span style="color: #BBBBBB; text-decoration: underline;">WCSCoverageDescription</span><span style="color: #BBBBBB;">&gt;</span></span></span>
<span><span class="co">#&gt; ....|-- <span style="font-style: italic;">boundedBy</span>  [<span style="color: #BB00BB;">srsName=</span><span style="color: #00BB00;">http://www.opengis.net/def/crs/EPSG/0/31370</span>,<span style="color: #BB00BB;">axisLabels=</span><span style="color: #00BB00;">x y</span>,<span style="color: #BB00BB;">uomLabels=</span><span style="color: #00BB00;">Meter Meter</span>,<span style="color: #BB00BB;">srsDimension=</span><span style="color: #00BB00;">2</span>] <span style="color: #BBBBBB;">&lt;</span><span style="color: #BBBBBB; text-decoration: underline;">GMLEnvelope</span><span style="color: #BBBBBB;">&gt;</span></span></span>
<span><span class="co">#&gt; ........|-- <span style="font-style: italic;">lowerCorner</span>: <span style="background-color: #BBBBBB;">17000 148000</span></span></span>
<span><span class="co">#&gt; ........|-- <span style="font-style: italic;">upperCorner</span>: <span style="background-color: #BBBBBB;">264000 250000</span></span></span>
<span><span class="co">#&gt; ....|-- <span style="font-style: italic;">domainSet</span>  [<span style="color: #BB00BB;">gml:id=</span><span style="color: #00BB00;">grid_DHMVII_DTM_1m</span>,<span style="color: #BB00BB;">dimension=</span><span style="color: #00BB00;">2</span>] <span style="color: #BBBBBB;">&lt;</span><span style="color: #BBBBBB; text-decoration: underline;">GMLRectifiedGrid</span><span style="color: #BBBBBB;">&gt;</span></span></span>
<span><span class="co">#&gt; ........|-- <span style="font-style: italic;">limits</span> <span style="color: #BBBBBB;">&lt;</span><span style="color: #BBBBBB; text-decoration: underline;">GMLGridEnvelope</span><span style="color: #BBBBBB;">&gt;</span></span></span>
<span><span class="co">#&gt; ............|-- <span style="font-style: italic;">low</span>: <span style="background-color: #BBBBBB;">0 0</span></span></span>
<span><span class="co">#&gt; ............|-- <span style="font-style: italic;">high</span>: <span style="background-color: #BBBBBB;">246999 101999</span></span></span>
<span><span class="co">#&gt; ........|-- <span style="font-style: italic;">axisLabels</span> </span></span>
<span><span class="co">#&gt; ............|-- <span style="font-style: italic;">value</span>: <span style="background-color: #BBBBBB;">x y</span></span></span>
<span><span class="co">#&gt; ........|-- <span style="font-style: italic;">origin</span>  [<span style="color: #BB00BB;">gml:id=</span><span style="color: #00BB00;">grid_origin_DHMVII_DTM_1m</span>,<span style="color: #BB00BB;">srsName=</span><span style="color: #00BB00;">http://www.opengis.net/def/crs/EPSG/0/31370</span>] <span style="color: #BBBBBB;">&lt;</span><span style="color: #BBBBBB; text-decoration: underline;">GMLPoint</span><span style="color: #BBBBBB;">&gt;</span></span></span>
<span><span class="co">#&gt; ............|-- <span style="font-style: italic;">pos</span>: <span style="background-color: #BBBBBB;">17000.5 249999.5</span></span></span>
<span><span class="co">#&gt; ........|-- <span style="font-style: italic;">offsetVector</span>  [<span style="color: #BB00BB;">srsName=</span><span style="color: #00BB00;">EPSG:31370</span>,<span style="color: #BB00BB;">srsDimension=</span><span style="color: #00BB00;">2</span>] </span></span>
<span><span class="co">#&gt; ............|-- <span style="font-style: italic;">value</span>: <span style="background-color: #BBBBBB;">1 0</span></span></span>
<span><span class="co">#&gt; ........|-- <span style="font-style: italic;">offsetVector</span>  [<span style="color: #BB00BB;">srsName=</span><span style="color: #00BB00;">EPSG:31370</span>,<span style="color: #BB00BB;">srsDimension=</span><span style="color: #00BB00;">2</span>] </span></span>
<span><span class="co">#&gt; ............|-- <span style="font-style: italic;">value</span>: <span style="background-color: #BBBBBB;">0 -1</span></span></span>
<span><span class="co">#&gt; ....|-- <span style="font-style: italic;">rangeType</span> <span style="color: #BBBBBB;">&lt;</span><span style="color: #BBBBBB; text-decoration: underline;">SWEDataRecord</span><span style="color: #BBBBBB;">&gt;</span></span></span>
<span><span class="co">#&gt; ........|-- <span style="font-style: italic;">field</span> <span style="color: #BBBBBB;">&lt;</span><span style="color: #BBBBBB; text-decoration: underline;">SWEQuantity</span><span style="color: #BBBBBB;">&gt;</span></span></span>
<span><span class="co">#&gt; ............|-- <span style="font-style: italic;">description</span> </span></span>
<span><span class="co">#&gt; ................|-- <span style="font-style: italic;">value</span>: <span style="background-color: #BBBBBB;">Band 1</span></span></span>
<span><span class="co">#&gt; ............|-- <span style="font-style: italic;">nilValues</span> <span style="color: #BBBBBB;">&lt;</span><span style="color: #BBBBBB; text-decoration: underline;">SWENilValues</span><span style="color: #BBBBBB;">&gt;</span></span></span>
<span><span class="co">#&gt; ................|-- <span style="font-style: italic;">nilValue</span>  [<span style="color: #BB00BB;">reason=</span><span style="color: #00BB00;">http://www.opengis.net/def/nil/OGC/0/inapplicable</span>] </span></span>
<span><span class="co">#&gt; ....................|-- <span style="font-style: italic;">value</span>: <span style="background-color: #BBBBBB;">-9999</span></span></span>
<span><span class="co">#&gt; ............|-- <span style="font-style: italic;">uom</span>  [<span style="color: #BB00BB;">code=</span><span style="color: #00BB00;">unknown</span>] </span></span>
<span><span class="co">#&gt; ............|-- <span style="font-style: italic;">constraint</span> </span></span>
<span><span class="co">#&gt; ................|-- <span style="font-style: italic;">AllowedValues</span> </span></span>
<span><span class="co">#&gt; ....................|-- <span style="font-style: italic;">interval</span> </span></span>
<span><span class="co">#&gt; ........................|-- <span style="font-style: italic;">value</span>: <span style="background-color: #BBBBBB;">-99.890144 354.144226</span></span></span>
<span><span class="co">#&gt; ....|-- <span style="font-style: italic;">CoverageId</span> </span></span>
<span><span class="co">#&gt; ........|-- <span style="font-style: italic;">value</span>: <span style="background-color: #BBBBBB;">DHMVII_DTM_1m</span></span></span>
<span><span class="co">#&gt; ....|-- <span style="font-style: italic;">ServiceParameters</span> <span style="color: #BBBBBB;">&lt;</span><span style="color: #BBBBBB; text-decoration: underline;">ISOElementSequence</span><span style="color: #BBBBBB;">&gt;</span></span></span>
<span><span class="co">#&gt; ........|-- <span style="font-style: italic;">CoverageSubtype</span>: <span style="background-color: #BBBBBB;">RectifiedGridCoverage</span></span></span>
<span><span class="co">#&gt; ........|-- <span style="font-style: italic;">nativeFormat</span>: <span style="background-color: #BBBBBB;">image/tiff</span></span></span></code></pre></div>
<p>Finally, it is important to know which dimensions are available:
<code>LON/LAT</code>, <code>x/y</code>, or maybe <code>time</code>?</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dtm_dims</span> <span class="op">&lt;-</span> <span class="va">dtm_smry</span><span class="op">$</span><span class="fu">getDimensions</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [ows4R][INFO] WCSCoverageSummary - Fetching Coverage envelope dimensions by CRS interpretation</span></span>
<span><span class="co">#&gt; No encoding supplied: defaulting to UTF-8.</span></span>
<span><span class="va">dtm_dims</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; [[1]]$label</span></span>
<span><span class="co">#&gt; [1] "x"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[1]]$uom</span></span>
<span><span class="co">#&gt; [1] "Meter"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[1]]$type</span></span>
<span><span class="co">#&gt; [1] "geographic"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; [[2]]$label</span></span>
<span><span class="co">#&gt; [1] "y"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]$uom</span></span>
<span><span class="co">#&gt; [1] "Meter"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]$type</span></span>
<span><span class="co">#&gt; [1] "geographic"</span></span></code></pre></div>
<p>So far, so good.</p>
<p>Now, following the tutorials to get some real data:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x_test</span> <span class="op">&lt;-</span> <span class="fl">148600</span></span>
<span><span class="va">y_test</span> <span class="op">&lt;-</span> <span class="fl">208900</span></span>
<span><span class="va">range_m</span> <span class="op">&lt;-</span> <span class="fl">2</span> <span class="co"># (+/- m)</span></span>
<span></span>
<span><span class="va">hopo_boxed</span> <span class="op">&lt;-</span> <span class="va">OWSUtils</span><span class="op">$</span><span class="fu">toBBOX</span><span class="op">(</span></span>
<span>  xmin <span class="op">=</span> <span class="va">x_test</span> <span class="op">-</span> <span class="va">range_m</span>,</span>
<span>  xmax <span class="op">=</span> <span class="va">x_test</span> <span class="op">+</span> <span class="va">range_m</span>,</span>
<span>  ymin <span class="op">=</span> <span class="va">y_test</span> <span class="op">-</span> <span class="va">range_m</span>,</span>
<span>  ymax <span class="op">=</span> <span class="va">y_test</span> <span class="op">+</span> <span class="va">range_m</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>I will write the file to disk:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mht_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".mht"</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">dtm_data</span> <span class="op">&lt;-</span> <span class="va">dtm_smry</span><span class="op">$</span><span class="fu">getCoverage</span><span class="op">(</span></span>
<span>    bbox <span class="op">=</span> <span class="va">hopo_boxed</span>,</span>
<span>    filename <span class="op">=</span> <span class="va">mht_file</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span>, error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">err</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="va">err</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; [ows4R][WARN] WCSCoverageSummary - Coverage without temporal dimension: 'time' argument is ignored </span></span>
<span><span class="co">#&gt; [ows4R][WARN] WCSCoverageSummary - Coverage without vertical dimension: 'elevation' argument is ignored </span></span>
<span><span class="co">#&gt; <span style="color: #BBBBBB;">&lt;</span><span style="color: #BBBBBB; text-decoration: underline;">GMLEnvelope</span><span style="color: #BBBBBB;">&gt;</span></span></span>
<span><span class="co">#&gt; ....|-- <span style="font-style: italic;">lowerCorner</span>: <span style="background-color: #BBBBBB;">148598 208898</span></span></span>
<span><span class="co">#&gt; ....|-- <span style="font-style: italic;">upperCorner</span>: <span style="background-color: #BBBBBB;">148602 208902</span>[ows4R][INFO] WCSGetCoverage - Fetching https://geo.api.vlaanderen.be/DHMV/wcs?service=WCS&amp;version=2.0.1&amp;coverageId=DHMVII_DTM_1m&amp;subset=x(148598,148602)&amp;subset=y(208898,208902)&amp;format=image/tiff&amp;request=GetCoverage </span></span>
<span><span class="co">#&gt;   |                                                                              |                                                                      |   0%  |                                                                              |======================================================================| 100%</span></span>
<span><span class="co">#&gt; Start tag expected, '&lt;' not found</span></span>
<span><span class="co">#&gt; Warning in new_CppObject_xp(fields$.module, fields$.pointer, ...): GDAL Error</span></span>
<span><span class="co">#&gt; 4: `/tmp/RtmpNYlaDW/file1f753c7866af.mht' not recognized as a supported file</span></span>
<span><span class="co">#&gt; format.</span></span>
<span><span class="co">#&gt; Error: [rast] cannot open this file as a SpatRaster: /tmp/RtmpNYlaDW/file1f753c7866af.mht</span></span></code></pre></div>
<p>… or, maybe not. The function fails, somehow.</p>
<p><em>Status quo:</em></p>
<ul>
<li>I receive a file (an “mht” because <em>I called it</em> “mht”),
supposedly some kind of GeoTIFF image (because I <em>asked</em> for
<code>image/tiff</code>), yet wrapped into other data chunks.</li>
<li>I also receive a couple of error messages and warnings:
<ul>
<li><em>“Start tag expected, ‘&lt;’ not found”</em></li>
<li><em>“cannot open this file as SpatRaster:…”</em></li>
<li>The raw file is <em>“not recognized as being in a supported file
format. (GDAL error 4)”</em>
</li>
</ul>
</li>
</ul>
<p>Maybe most useful, <code>ows4R</code> briefly displays the URL it
used to attempt data query:
<code>https://geo.api.vlaanderen.be/DHMV/wcs?service=WCS&amp;version=2.0.1&amp;coverageId=DHMVII_DTM_1m&amp;subset=x(148599,148601)&amp;subset=y(208899,208901)&amp;format=image/tiff&amp;request=GetCoverage</code></p>
<p>Let’s break this URL down:</p>
<ul>
<li>the desired <code>service</code> is indeed <code>WCS</code>,</li>
<li>
<code>version</code> is <code>2.0.1</code> (I would guess)</li>
<li>
<code>request</code>, <code>coverageID</code>, and
<code>format</code> seem to be as expected</li>
<li>there are <code>subset</code> components for the respective
dimensions.</li>
</ul>
<p>Feel free to try yourself to paste the URL to a browser and download
the file.</p>
<p>Still, the downloaded file is unreadable. Subtle symptom: even if one
adjusts the <code>subset</code> (i.e. <code>bbox</code> argument,
above), the received tif does not change in size; the download is
bbox-agnostic, so to speak.</p>
<p>Opening the file with a text editor such as <a href="https://www.vim.org" class="external-link">vim</a>, we see an XML part, some generic
binary stuff, some hints that this <a href="https://en.wikipedia.org/wiki/Geography_Markup_Language" class="external-link">should be
a GML</a>.</p>
<p>There are <a href="https://github.com/mommermi/geotiff_sample/blob/master/sample.tif" class="external-link">sample
geoTIFFs online</a>, and they look different, or maybe not. GML is
clearly not geoTIFF, except maybe for the binary part (which I tried to
extract, to no avail).</p>
<p>The file does not download with an extension on the author’s OS and
browser. On a different OS, the browser automatically extended it with
“.mht”. In fact, it is <a href="https://docs.fileformat.com/web/mht" class="external-link">an
MHT file</a>. More on that <a href="#mht_solution">below</a>.</p>
<p><a id="orgfaa5a3d"></a></p>
</div>
<div class="section level2">
<h2 id="the-lead-qgis">The Lead: QGIS<a class="anchor" aria-label="anchor" href="#the-lead-qgis"></a>
</h2>
<p>Well, there is advanced software to open GeoTIFF’esque files. Or
geography markup. At least some software might be able to identify what
we actually have here.</p>
<p>First, if R failed, Python might work.</p>
<pre><code>import rasterio
import rasterio.plot

data_name = "/tmp/test_hopo.tif"
tiff = rasterio.open(data_name)
rasterio.plot.show(tiff, title = "will this work? no!")</code></pre>
<p>… but it doesn’t recognize the file type as raster data.</p>
<p>How about <strong><a href="https://qgis.org" class="external-link">QGIS</a>?</strong>
<em>“Spatial Without Compromise”</em>, they advertise. Unfortunately,
that program also was unable to open the file downloaded in R.</p>
<p>However, QGIS can actually connect to WCS directly. This does not
help much if you need the data in R. Yet, why not.</p>
<p>Look and behold: QGIS can actually connect to
&lt;<code>https://geo.api.vlaanderen.be/DHMV/wcs</code>&gt; and query
elevation data for Flanders; good indication that the WCS is, somehow,
functional. I could zoom and move, export images. I could even export
the data. I stopped exporting the data when it threatened to entirely
fill my tiny system partition (the raster data is more than 100GB) -
good confirmation that we want web services for this.</p>
<p>And, luckily, at some careless map movement, I received an error
output from QGIS. With it, QGIS gave me a working URL to query DHMV:</p>
<ul>
<li><code>https://geo.api.vlaanderen.be/DHMV/wcs?SERVICE=WCS&amp;VERSION=1.0.0&amp;REQUEST=GetCoverage&amp;FORMAT=GeoTIFF&amp;COVERAGE=DHMVII_DTM_1m&amp;BBOX=162064,165735,170953,168882&amp;CRS=EPSG:31370&amp;RESPONSE_CRS=EPSG:31370&amp;WIDTH=1622&amp;HEIGHT=574</code></li>
</ul>
<p><img src="../reference/figures/qgis_lead.avif" width="90%"></p>
<p>Let’s dissect this URL.</p>
<p><a id="org803f24d"></a></p>
</div>
<div class="section level2">
<h2 id="the-solution-query-building">The Solution: Query Building<a class="anchor" aria-label="anchor" href="#the-solution-query-building"></a>
</h2>
<p>If you start at the question mark of the URL, and split at every
ampersand, you can extract the following components from the (correct)
QGIS URL:</p>
<table class="table">
<thead><tr class="header">
<th><strong>correct:</strong></th>
<th></th>
</tr></thead>
<tbody>
<tr class="odd">
<td>SERVICE</td>
<td>WCS</td>
</tr>
<tr class="even">
<td>VERSION</td>
<td>1.0.0</td>
</tr>
<tr class="odd">
<td>REQUEST</td>
<td>GetCoverage</td>
</tr>
<tr class="even">
<td>FORMAT</td>
<td>GeoTIFF</td>
</tr>
<tr class="odd">
<td>COVERAGE</td>
<td>DHMVII_DTM_1m</td>
</tr>
<tr class="even">
<td>BBOX</td>
<td>162064,165735,170953,168882</td>
</tr>
<tr class="odd">
<td>CRS</td>
<td>EPSG:31370</td>
</tr>
<tr class="even">
<td>RESPONSE_CRS</td>
<td>EPSG:31370</td>
</tr>
<tr class="odd">
<td>WIDTH</td>
<td>1622</td>
</tr>
<tr class="even">
<td>HEIGHT</td>
<td>574</td>
</tr>
</tbody>
</table>
<p>Compare this to the (unsuccessful) <code>ows4R</code> attempt:</p>
<table class="table">
<thead><tr class="header">
<th><strong>non-functional:</strong></th>
<th></th>
</tr></thead>
<tbody>
<tr class="odd">
<td>service</td>
<td>WCS</td>
</tr>
<tr class="even">
<td>version</td>
<td>2.0.1</td>
</tr>
<tr class="odd">
<td>coverageId</td>
<td>DHMVII_DTM_1m</td>
</tr>
<tr class="even">
<td>subset</td>
<td>x(148599,148601)</td>
</tr>
<tr class="odd">
<td>subset</td>
<td>y(208899,208901)</td>
</tr>
<tr class="even">
<td>format</td>
<td>image/tiff</td>
</tr>
<tr class="odd">
<td>request</td>
<td>GetCoverage</td>
</tr>
</tbody>
</table>
<p>You can selectively shuffle and adjust components, generalizing the
working query and learning about the WCS interface. Which feels a bit
like <a href="https://en.wikipedia.org/wiki/Fuzzing" class="external-link">fuzzing</a> the
WCS.</p>
<p>Here is what I found:</p>
<ul>
<li>
<code>service</code> (<code>WCS</code>) and <code>request</code>
(<code>DHMVII_DTM_1m</code>) were correct; the latter could be swapped
for different datasets</li>
<li>
<code>coverage</code> is the correct keyword for reading
<code>DHMVII_DTM_1m</code>
</li>
<li>
<code>version</code> must be <code>1.0.0</code>; it currently does
not work with 2.0.1</li>
<li>instead of subsetting, we can use a <code>bbox</code>…</li>
<li>… but a <code>width</code> and <code>height</code> of the output
image are mandatory; alternatively there are <code>resx</code> and
<code>resy</code> (not shown)</li>
<li>we must specify a <code>CRS</code> (<code>EPSG:31370</code>),
optionally also a <code>response_crs</code>
</li>
<li>the <code>format</code> is <code>GeoTIFF</code>; slashes are weird
in URLs anyway</li>
</ul>
<p>After some more trial and error, I could construct working URLs in R
and generalize this to a function.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">get_elevation_wcs</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">range_m</span> <span class="op">=</span> <span class="fl">1</span>, <span class="va">tiff_file</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Please note that this function lacks a lot of</span></span>
<span>  <span class="co"># assertions and documentation.</span></span>
<span></span>
<span>  <span class="co"># get bbox</span></span>
<span>  <span class="va">bbox</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="va">range_m</span>, <span class="va">x</span> <span class="op">+</span> <span class="va">range_m</span>,</span>
<span>               <span class="va">y</span> <span class="op">-</span> <span class="va">range_m</span>, <span class="va">y</span> <span class="op">+</span> <span class="va">range_m</span>,</span>
<span>               sep <span class="op">=</span> <span class="st">","</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># the URL components</span></span>
<span>  <span class="va">base_url</span> <span class="op">&lt;-</span> <span class="st">"https://geo.api.vlaanderen.be"</span></span>
<span>  <span class="va">endpoint</span> <span class="op">&lt;-</span> <span class="st">"/DHMV/wcs"</span> <span class="co"># nolint: absolute_path_linter</span></span>
<span></span>
<span>  <span class="co"># the query parameters which worked in QGIS</span></span>
<span>  <span class="va">elevation_query</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    service <span class="op">=</span> <span class="st">"WCS"</span>,</span>
<span>    version <span class="op">=</span> <span class="st">"1.0.0"</span>,</span>
<span>    request <span class="op">=</span> <span class="st">"GetCoverage"</span>,</span>
<span>    format <span class="op">=</span> <span class="st">"GeoTIFF"</span>,</span>
<span>    coverage <span class="op">=</span> <span class="st">"DHMVII_DTM_1m"</span>,</span>
<span>    bbox <span class="op">=</span> <span class="va">bbox</span>,</span>
<span>    width <span class="op">=</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">range_m</span>,</span>
<span>    height <span class="op">=</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">range_m</span>,</span>
<span>    crs <span class="op">=</span> <span class="st">"EPSG:31370"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># get wcs data</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">tiff_file</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">tiff_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".tiff"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu"><a href="https://httr.r-lib.org/reference/GET.html" class="external-link">GET</a></span><span class="op">(</span>url <span class="op">=</span> <span class="fu"><a href="https://httr.r-lib.org/reference/modify_url.html" class="external-link">modify_url</a></span><span class="op">(</span><span class="va">base_url</span>, path <span class="op">=</span> <span class="va">endpoint</span><span class="op">)</span>,</span>
<span>      query <span class="op">=</span> <span class="va">elevation_query</span>,</span>
<span>      <span class="fu"><a href="https://httr.r-lib.org/reference/write_disk.html" class="external-link">write_disk</a></span><span class="op">(</span><span class="va">tiff_file</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># note: saving this to a file is optional,</span></span>
<span>  <span class="co"># but might prevent double download or loss of data</span></span>
<span></span>
<span>  <span class="co"># re-read raster file</span></span>
<span>  <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">tiff_file</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Example usage:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x_test</span> <span class="op">&lt;-</span> <span class="fl">148600</span></span>
<span><span class="va">y_test</span> <span class="op">&lt;-</span> <span class="fl">208900</span></span>
<span><span class="va">range_m</span> <span class="op">&lt;-</span> <span class="fl">10</span> <span class="co"># (+/- m)</span></span>
<span><span class="va">test_raster</span> <span class="op">&lt;-</span> <span class="fu">get_elevation_wcs</span><span class="op">(</span><span class="va">x_test</span>, <span class="va">y_test</span>, range_m <span class="op">=</span> <span class="va">range_m</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># we can extract a value at a point:</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">test_raster</span>, <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">x_test</span>, <span class="va">y_test</span><span class="op">)</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] 9.899891</span></span></code></pre></div>
<p>Voilà! We can now get the elevation of a given location in Flanders
via DHMV web services.</p>
<p>Major grain of salt: we could not use the latest version,
<code>v2.0.1</code>, of the DHMV WCS. This is not a minor limitation,
and should be taken seriously: old versions become obsolete, break, or
stop data updates.</p>
<p><a id="mht_solution"></a></p>
</div>
<div class="section level2">
<h2 id="using-version-2-0-1">Using Version <code>2.0.1</code><a class="anchor" aria-label="anchor" href="#using-version-2-0-1"></a>
</h2>
<p>Apparently, the exact symptoms of the failing query above are
somewhat depending on your browser and operating system. Your browser
might detect that the file is an <code>mht</code>, or not.</p>
<p>Here is an example of how to build a query with the current version
of DHMV:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">url</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://httr.r-lib.org/reference/parse_url.html" class="external-link">parse_url</a></span><span class="op">(</span><span class="st">"https://geo.api.vlaanderen.be/DHMV/wcs"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># the query parameters which worked in QGIS</span></span>
<span><span class="va">url</span><span class="op">$</span><span class="va">query</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  SERVICE <span class="op">=</span> <span class="st">"WCS"</span>,</span>
<span>  VERSION <span class="op">=</span> <span class="st">"2.0.1"</span>,</span>
<span>  REQUEST <span class="op">=</span> <span class="st">"GetCoverage"</span>,</span>
<span>  FORMAT <span class="op">=</span> <span class="st">"image/tiff"</span>,</span>
<span>  COVERAGEID <span class="op">=</span> <span class="st">"DHMVII_DTM_1m"</span>,</span>
<span>  SUBSET <span class="op">=</span> <span class="st">"x,http://www.opengis.net/def/crs/EPSG/0/EPSG:31370(148000,149000)"</span>,</span>
<span>  SUBSET <span class="op">=</span> <span class="st">"y,http://www.opengis.net/def/crs/EPSG/0/EPSG:31370(208000,209000)"</span>,</span>
<span>  SCALEFACTOR <span class="op">=</span> <span class="st">"1"</span>,</span>
<span>  CRS <span class="op">=</span> <span class="st">"EPSG:31370"</span>,</span>
<span>  RESPONSE_CRS <span class="op">=</span> <span class="st">"EPSG:31370"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">request</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://httr.r-lib.org/reference/parse_url.html" class="external-link">build_url</a></span><span class="op">(</span><span class="va">url</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># get wcs data</span></span>
<span><span class="va">mht_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".mht"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">request</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "https://geo.api.vlaanderen.be/DHMV/wcs?SERVICE=WCS&amp;VERSION=2.0.1&amp;REQUEST=GetCoverage&amp;FORMAT=image%2Ftiff&amp;COVERAGEID=DHMVII_DTM_1m&amp;SUBSET=x%2Chttp%3A%2F%2Fwww.opengis.net%2Fdef%2Fcrs%2FEPSG%2F0%2FEPSG%3A31370%28148000%2C149000%29&amp;SUBSET=y%2Chttp%3A%2F%2Fwww.opengis.net%2Fdef%2Fcrs%2FEPSG%2F0%2FEPSG%3A31370%28208000%2C209000%29&amp;SCALEFACTOR=1&amp;CRS=EPSG%3A31370&amp;RESPONSE_CRS=EPSG%3A31370"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">mht_file</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "/tmp/RtmpNYlaDW/file1f751102f7a8.mht"</span></span>
<span></span>
<span><span class="va">response</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://httr.r-lib.org/reference/GET.html" class="external-link">GET</a></span><span class="op">(</span>url <span class="op">=</span> <span class="va">request</span>,</span>
<span>          <span class="fu"><a href="https://httr.r-lib.org/reference/write_disk.html" class="external-link">write_disk</a></span><span class="op">(</span><span class="va">mht_file</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>With the <code>mht</code> specifications <a href="https://docs.fileformat.com/web/mht" class="external-link">found online</a>, it is
possible to create an unpacking function, which has become part of this
very package.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://readr.tidyverse.org" class="external-link">"readr"</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://stringr.tidyverse.org" class="external-link">"stringr"</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">unpack_mht</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mht_filepath</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">lines_raw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_lines.html" class="external-link">read_lines_raw</a></span><span class="op">(</span><span class="va">mht_filepath</span><span class="op">)</span></span>
<span>  <span class="va">lines_char</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_lines.html" class="external-link">read_lines</a></span><span class="op">(</span><span class="va">mht_filepath</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">raw_vector</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_file.html" class="external-link">read_file_raw</a></span><span class="op">(</span><span class="va">mht_filepath</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">lines_char</span>, <span class="st">"^II\\*"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">end</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">lines_raw</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span>
<span>  <span class="va">pos_start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">lines_raw</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">start</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="va">start</span></span>
<span>  <span class="va">pos_end</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">raw_vector</span><span class="op">)</span> <span class="op">-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">lines_raw</span><span class="op">[</span><span class="va">end</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">tif</span> <span class="op">&lt;-</span> <span class="va">raw_vector</span><span class="op">[</span><span class="va">pos_start</span><span class="op">:</span><span class="va">pos_end</span><span class="op">]</span></span>
<span>  <span class="va">tif_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html" class="external-link">str_replace</a></span><span class="op">(</span><span class="va">mht_filepath</span>, <span class="st">"mht"</span>, <span class="st">"tif"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://readr.tidyverse.org/reference/read_file.html" class="external-link">write_file</a></span><span class="op">(</span></span>
<span>    <span class="va">tif</span>,</span>
<span>    <span class="va">tif_path</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">tif_path</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This way you get the elevation data extracted:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tif_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/unpack_mht.html">unpack_mht</a></span><span class="op">(</span><span class="va">mht_file</span><span class="op">)</span></span>
<span><span class="va">raster</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">tif_file</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">raster</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/gray.colors.html" class="external-link">gray.colors</a></span><span class="op">(</span><span class="fl">256</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="spatial_dhmv_query_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
<p><a id="orgd59526e"></a></p>
</div>
<div class="section level2">
<h2 id="the-inbospatial-way">The “<code>inbospatial</code>” Way<a class="anchor" aria-label="anchor" href="#the-inbospatial-way"></a>
</h2>
<p>Colleague <a href="https://github.com/hansvancalster" class="external-link">Hans Van
Calster</a> had been facing the same problems with related WCS layers a
year earlier, and he wrote a function for it in <a href="https://github.com/inbo/inbospatial" class="external-link">the `inbospatial`
package</a>. We now refined the <code><a href="../reference/get_coverage_wcs.html">get_coverage_wcs()</a></code>
procedure to solve the <code>mht</code> issue.</p>
<p>Here is how to use it, for the same case as above:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bbox</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html" class="external-link">st_bbox</a></span><span class="op">(</span></span>
<span>   <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="fl">148000</span>, xmax <span class="op">=</span> <span class="fl">149000</span>, ymin <span class="op">=</span> <span class="fl">208000</span>, ymax <span class="op">=</span> <span class="fl">209000</span><span class="op">)</span>,</span>
<span>   crs <span class="op">=</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="fl">31370</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">hopo_raster</span> <span class="op">&lt;-</span> <span class="fu">inbospatial</span><span class="fu">::</span><span class="fu"><a href="../reference/get_coverage_wcs.html">get_coverage_wcs</a></span><span class="op">(</span></span>
<span>  wcs <span class="op">=</span> <span class="st">"dhmv"</span>,</span>
<span>  bbox <span class="op">=</span> <span class="va">bbox</span>,</span>
<span>  layername <span class="op">=</span> <span class="st">"DHMVII_DTM_1m"</span>,</span>
<span>  version <span class="op">=</span> <span class="st">"2.0.1"</span>,</span>
<span>  wcs_crs <span class="op">=</span> <span class="st">"EPSG:31370"</span>,</span>
<span>  resolution <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">hopo_raster</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/gray.colors.html" class="external-link">gray.colors</a></span><span class="op">(</span><span class="fl">256</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="spatial_dhmv_query_files/figure-html/unnamed-chunk-15-1.png" width="700"></p>
<p>The function gives you quite some options of WCS layers to query data
from.</p>
<table class="table">
<colgroup>
<col width="33%">
<col width="58%">
<col width="7%">
</colgroup>
<thead><tr class="header">
<th><strong>WCS</strong></th>
<th><strong>layer name</strong></th>
<th><strong>reference</strong></th>
</tr></thead>
<tbody>
<tr class="odd">
<td>dtm</td>
<td><code>EL.GridCoverage.DTM</code></td>
<td><a href="https://www.vlaanderen.be/datavindplaats/catalogus/hoogte-dtm" class="external-link">here</a></td>
</tr>
<tr class="even">
<td>dsm</td>
<td><code>EL.GridCoverage.DSM</code></td>
<td><a href="https://www.vlaanderen.be/datavindplaats/catalogus/hoogte-dsm" class="external-link">here</a></td>
</tr>
<tr class="odd">
<td>dhmv</td>
<td><code>DHMVI_DTM_5m</code></td>
<td><a href="https://metadata.vlaanderen.be/srv/dut/catalog.search#/metadata/9b0f82c7-57c4-463a-8918-432e41a66355" class="external-link">here</a></td>
</tr>
<tr class="even">
<td>dhmv</td>
<td><code>DHMVII_DTM_1m</code></td>
<td><a href="https://metadata.vlaanderen.be/srv/dut/catalog.search#/metadata/f52b1a13-86bc-4b64-8256-88cc0d1a8735" class="external-link">here</a></td>
</tr>
<tr class="odd">
<td>dhmv</td>
<td><code>DHMVII_DSM_1m</code></td>
<td><a href="https://metadata.vlaanderen.be/srv/dut/catalog.search#/metadata/0da2e5e4-6886-426b-bb82-c0ffe6faeff6" class="external-link">here</a></td>
</tr>
</tbody>
</table>
<p>At a quick glance, we found that the <code>dtm</code> WCS seems to
include canopy points, which is not according to definition; see here:
<a href="https://www.neonscience.org/resources/learning-hub/tutorials/chm-dsm-dtm" class="external-link uri">https://www.neonscience.org/resources/learning-hub/tutorials/chm-dsm-dtm</a>
A general advice is to confirm your data for a region you know.</p>
<p>In addition, there are <code>oi-omz</code> and <code>oi-omw</code>
for “zummer” and winter ortho-mosaic images.</p>
<p>The burden of choice!</p>
<p><a id="org575ca41"></a></p>
</div>
<div class="section level2">
<h2 id="post-mortem">
<em>Post Mortem</em><a class="anchor" aria-label="anchor" href="#post-mortem"></a>
</h2>
<p>The value of this vignette seems to be limited: in essence, it
provides the specific query function arguments for elevation model
queries with the <code>geo.api</code> WCS of the Flemish digital
services. Quite a niche use case.</p>
<p>However, this is also a story of tracing errors in existing tools,
and scraping other tools for hints.</p>
<p>Can we actually trace the error back to a source? It was pure
co-incidence that QGIS provided a working link, or are there general
strategies? As colleague <a href="https://github.com/inbo/inbospatial/pull/14#discussion_r1853858729" class="external-link"><span class="citation">@florisvdh</span> pointed out,</a> <a href="https://github.com/qgis/QGIS" class="external-link">QGIS</a> generally has good
heuristics to infer a web service URL, and choose parameter values which
work. Once a web service layer is successfully loaded in QGIS, one can
inspect URLs and metadata in the layer properties. The QGIS dialogue to
add a web service layer is also helpful in exploring available layers of
a web service.</p>
<p>In retrospective, the initial issue was worsened by unfavourable
circumstances.</p>
<ul>
<li>
<code>ows4R</code> retrieved a file and produced an error; another
error was only thrown downstream. Neither <code>ows4R</code>, nor
<code>terra</code>, <code>sf</code>, <code>rasterio</code>, or
<code>qgis</code> were able to handle <code>mht</code> files. This lack
of support questions the WCS design choice of packing and sending an
<code>mht</code>.</li>
<li>Documentation for the <code>geo.api.vlaanderen.be</code> WCS is
lacking (or I did not find it); in particularly I missed usage examples,
vignettes, or tests.</li>
</ul>
<p>The colleagues at <code>Digitaal Vlaanderen</code> or the DHMV group
certainly had enough work on their table, yet more documentation would
be desirable. Same for <code>ows4R</code>, judging by their <a href="https://github.com/eblondel/ows4R/issues" class="external-link">github issue list</a>
(see e.g. <a href="https://github.com/eblondel/ows4R/issues/114" class="external-link">this
one</a>). On the other hand, <a href="https://en.wikipedia.org/wiki/QGIS" class="external-link">QGIS is free- and open
source</a>, its queries seem to be well maintained and are accessible,
errors are transparent, I could have read the source code - a good
example piece of software.</p>
<p>Yet in general, if you run into issues like this, do not hesitate to
contact support or <a href="https://github.com/eblondel/ows4R/issues/114" class="external-link">file a github
issue</a>. You should not need to fuzz a WCS.</p>
<p>Thank you for reading, and may all your spatial queries be
successful!</p>
</div>
<div class="section level2">
<h2 id="table-of-contents">Table of Contents<a class="anchor" aria-label="anchor" href="#table-of-contents"></a>
</h2>
<ul>
<li><a href="#org86b1211">DHMV Data</a></li>
<li><a href="#org75073fb">Situation/Motivation</a></li>
<li><a href="#orge6d66b9">Limits of <code>ows4R</code> Package</a></li>
<li><a href="#orgfaa5a3d">The Lead: QGIS</a></li>
<li><a href="#org803f24d">The Solution: Query Building</a></li>
<li><a href="#mht_solution">Using Version <code>2.0.1</code></a></li>
<li><a href="#orgd59526e">The “inbospatial” Way</a></li>
<li><a href="#org575ca41">Post Mortem</a></li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/hansvancalster" class="external-link">Hans Van Calster</a>, <a href="https://www.vlaanderen.be/inbo/en-gb" class="external-link"><img src="https://inbo.github.io/checklist/reference/figures/logo-en.png" height="24" alt="logo of the Research Institute for Nature and Forest (INBO)"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
